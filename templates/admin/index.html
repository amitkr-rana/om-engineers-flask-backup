{% extends "admin/base.html" %}

{% block title %}Admin Dashboard - {{ config.APP_NAME }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-8);">
    <h1>Dashboard</h1>
    <div style="display: flex; gap: var(--space-4);">
        <button onclick="refreshStats()" class="btn btn-secondary btn-sm">üîÑ Refresh</button>
        <button onclick="showDatabaseInfo()" class="btn btn-secondary btn-sm">üìä DB Info</button>
        <button onclick="showResetModal()" class="btn btn-danger btn-sm">üóëÔ∏è Reset Database</button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="customers-count">{{ stats.customers or 0 }}</div>
        <div style="color: var(--gray-600);">Total Customers</div>
        <div style="margin-top: var(--space-2);">
            <a href="{{ url_for('admin.customers') }}" class="btn btn-sm btn-outline">View All</a>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-number" id="services-count">{{ stats.services or 0 }}</div>
        <div style="color: var(--gray-600);">Total Services</div>
        <div style="margin-top: var(--space-2);">
            <a href="{{ url_for('admin.services') }}" class="btn btn-sm btn-outline">View All</a>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-number" id="appointments-count">{{ stats.appointments or 0 }}</div>
        <div style="color: var(--gray-600);">Total Appointments</div>
        <div style="margin-top: var(--space-2);">
            <a href="{{ url_for('admin.appointments') }}" class="btn btn-sm btn-outline">View All</a>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div style="background: var(--gray-50); padding: var(--space-6); border-radius: var(--border-radius-lg); margin-bottom: var(--space-8);">
    <h3 style="margin-bottom: var(--space-4);">Quick Actions</h3>
    <div style="display: flex; gap: var(--space-4); flex-wrap: wrap;">
        <a href="{{ url_for('admin.new_customer') }}" class="btn btn-primary">‚ûï Add Customer</a>
        <a href="{{ url_for('admin.new_service') }}" class="btn btn-primary">üîß Add Service</a>
        <a href="{{ url_for('admin.new_appointment') }}" class="btn btn-primary">üìÖ Add Appointment</a>
    </div>
</div>

<!-- Recent Activity -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-8); margin-top: var(--space-8);">
    <!-- Recent Customers -->
    <div>
        <h3 style="margin-bottom: var(--space-4);">Recent Customers</h3>
        {% if recent_customers %}
        <div class="card">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Address</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in recent_customers %}
                    <tr>
                        <td>{{ customer.name }}</td>
                        <td>{{ customer.email }}</td>
                        <td>
                            <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                 title="{{ customer.address or 'No address provided' }}">
                                {{ customer.address or 'No address' }}
                            </div>
                        </td>
                        <td>{{ customer.created_at.strftime('%m/%d/%Y') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card" style="text-align: center; padding: var(--space-8); color: var(--gray-500);">
            No customers yet
        </div>
        {% endif %}
    </div>

    <!-- Recent Appointments -->
    <div>
        <h3 style="margin-bottom: var(--space-4);">Recent Appointments</h3>
        {% if recent_appointments %}
        <div class="card">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for appointment in recent_appointments %}
                    <tr>
                        <td>#{{ appointment.id }}</td>
                        <td>
                            <span style="background-color:
                                {% if appointment.status.value == 'pending' %}var(--warning-color)
                                {% elif appointment.status.value == 'confirmed' %}var(--primary-color)
                                {% elif appointment.status.value == 'completed' %}var(--success-color)
                                {% elif appointment.status.value == 'cancelled' %}var(--error-color)
                                {% else %}var(--gray-400){% endif %};
                                color: var(--white); padding: var(--space-1) var(--space-2); border-radius: var(--border-radius-sm); font-size: var(--font-size-xs);">
                                {{ appointment.status.value.title() }}
                            </span>
                        </td>
                        <td>{{ appointment.appointment_date.strftime('%m/%d/%Y') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card" style="text-align: center; padding: var(--space-8); color: var(--gray-500);">
            No appointments yet
        </div>
        {% endif %}
    </div>
</div>

<!-- Database Info -->
<div style="margin-top: var(--space-12); padding: var(--space-6); background: var(--primary-color); color: var(--white); border-radius: var(--border-radius-lg);">
    <h3 style="color: var(--white); margin-bottom: var(--space-4);">üíæ Database Information</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); opacity: 0.9;">
        <div>
            <strong>Database Type:</strong> SQLite
        </div>
        <div>
            <strong>Location:</strong> om_engineers.db
        </div>
        <div>
            <strong>Environment:</strong> Development
        </div>
        <div>
            <strong>Last Updated:</strong> <span id="last-updated">{{ moment().format('MM/DD/YYYY HH:mm') if moment else 'Unknown' }}</span>
        </div>
    </div>
</div>

<!-- Database Info Modal -->
<div id="dbInfoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--white); padding: var(--space-8); border-radius: var(--border-radius-lg); max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: var(--space-4);">üìä Database Information</h3>
        <div id="dbInfoContent" style="margin-bottom: var(--space-6);">
            <p>Loading database information...</p>
        </div>
        <button onclick="closeDatabaseInfo()" class="btn btn-secondary">Close</button>
    </div>
</div>

<!-- Database Reset Confirmation Modal -->
<div id="resetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--white); padding: var(--space-8); border-radius: var(--border-radius-lg); max-width: 500px; width: 90%;">
        <h3 style="color: var(--error-color); margin-bottom: var(--space-4);">‚ö†Ô∏è Database Reset Confirmation</h3>

        <div style="background: var(--error-color); color: var(--white); padding: var(--space-4); border-radius: var(--border-radius-md); margin-bottom: var(--space-6);">
            <strong>WARNING:</strong> This action will permanently delete all data including:
            <ul style="margin: var(--space-2) 0; padding-left: var(--space-4);">
                <li>All customer records</li>
                <li>All service definitions</li>
                <li>All appointments</li>
                <li>All OTP records</li>
            </ul>
            This action cannot be undone!
        </div>

        <form method="POST" action="{{ url_for('admin.reset_database') }}" id="resetForm">
            <div style="margin-bottom: var(--space-4);">
                <label for="confirmationInput" style="display: block; margin-bottom: var(--space-2); font-weight: 500;">
                    To confirm, type <strong>RESET</strong> in the box below:
                </label>
                <input type="text" id="confirmationInput" name="confirmation"
                       style="width: 100%; padding: var(--space-3); border: 1px solid var(--gray-300); border-radius: var(--border-radius-md);"
                       placeholder="Type RESET to confirm"
                       autocomplete="off">
            </div>

            <div style="display: flex; gap: var(--space-4); justify-content: flex-end;">
                <button type="button" onclick="closeResetModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-danger" id="confirmResetBtn" disabled>üóëÔ∏è Reset Database</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshStats() {
    fetch('{{ url_for("admin.api_stats") }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('customers-count').textContent = data.customers || 0;
            document.getElementById('services-count').textContent = data.services || 0;
            document.getElementById('appointments-count').textContent = data.appointments || 0;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        })
        .catch(error => {
            console.error('Error fetching stats:', error);
        });
}

// Database Info Modal Functions
function showDatabaseInfo() {
    document.getElementById('dbInfoModal').style.display = 'block';
    document.getElementById('dbInfoContent').innerHTML = '<p>Loading database information...</p>';

    fetch('{{ url_for("admin.database_info") }}')
        .then(response => response.json())
        .then(data => {
            let content = `
                <div style="display: grid; gap: var(--space-3);">
                    <div><strong>File Status:</strong> ${data.file_exists ? '‚úÖ Exists' : '‚ùå Missing'}</div>
                    <div><strong>File Size:</strong> ${data.file_size}</div>
                    <div><strong>Last Modified:</strong> ${data.last_modified}</div>
                </div>
                <h4 style="margin: var(--space-4) 0 var(--space-2) 0;">Table Records:</h4>
                <div style="display: grid; gap: var(--space-2);">
            `;

            if (data.tables.error) {
                content += `<div style="color: var(--error-color);">${data.tables.error}</div>`;
            } else {
                content += `
                    <div>üë• Customers: ${data.tables.customers}</div>
                    <div>üîß Services: ${data.tables.services}</div>
                    <div>üìÖ Appointments: ${data.tables.appointments}</div>
                    <div>üîê OTP Records: ${data.tables.otp_records}</div>
                `;
            }

            content += '</div>';
            document.getElementById('dbInfoContent').innerHTML = content;
        })
        .catch(error => {
            document.getElementById('dbInfoContent').innerHTML =
                `<div style="color: var(--error-color);">Error loading database info: ${error.message}</div>`;
        });
}

function closeDatabaseInfo() {
    document.getElementById('dbInfoModal').style.display = 'none';
}

// Database Reset Modal Functions
function showResetModal() {
    document.getElementById('resetModal').style.display = 'block';
    document.getElementById('confirmationInput').value = '';
    document.getElementById('confirmResetBtn').disabled = true;
}

function closeResetModal() {
    document.getElementById('resetModal').style.display = 'none';
}

// Enable/disable reset button based on confirmation text
document.addEventListener('DOMContentLoaded', function() {
    const confirmationInput = document.getElementById('confirmationInput');
    const confirmResetBtn = document.getElementById('confirmResetBtn');

    if (confirmationInput) {
        confirmationInput.addEventListener('input', function() {
            confirmResetBtn.disabled = this.value.trim().toUpperCase() !== 'RESET';
        });
    }

    // Close modals when clicking outside
    document.getElementById('dbInfoModal').addEventListener('click', function(e) {
        if (e.target === this) closeDatabaseInfo();
    });

    document.getElementById('resetModal').addEventListener('click', function(e) {
        if (e.target === this) closeResetModal();
    });
});

// Auto-refresh stats every 30 seconds
setInterval(refreshStats, 30000);
</script>
{% endblock %}